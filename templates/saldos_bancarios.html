{% extends 'base.html' %}
{% block content %}

<div class="space-y-6">
    <!-- Header -->
    <div class="flex items-center justify-between">
        <div class="flex items-center">
            <a href="{{ url_for('index') }}" class="text-gray-500 hover:text-gray-700">
                <i data-lucide="arrow-left-circle" class="w-8 h-8"></i>
            </a>
            <h2 class="text-2xl font-bold text-gray-800 ml-4">Saldos Bancários</h2>
        </div>
        <button id="novo-saldo-btn"
            class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg flex items-center">
            <i data-lucide="plus" class="w-5 h-5 mr-2"></i>
            <span>Novo Saldo</span>
        </button>
    </div>

    <!-- Success Message -->
    {% if success_message %}
    <div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded-lg relative" role="alert">
        <div class="flex items-center">
            <i data-lucide="check-circle" class="w-5 h-5 mr-2"></i>
            <span class="block sm:inline">{{ success_message }}</span>
        </div>
        <button type="button" onclick="this.parentElement.remove()" class="absolute top-0 bottom-0 right-0 px-4 py-3">
            <i data-lucide="x" class="w-4 h-4"></i>
        </button>
    </div>
    {% endif %}

    <!-- Error Message -->
    {% if error_message %}
    <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg relative" role="alert">
        <div class="flex items-start">
            <i data-lucide="alert-circle" class="w-5 h-5 mr-2 mt-0.5"></i>
            <pre class="block sm:inline whitespace-pre-wrap text-sm">{{ error_message }}</pre>
        </div>
        <button type="button" onclick="this.parentElement.remove()" class="absolute top-0 bottom-0 right-0 px-4 py-3">
            <i data-lucide="x" class="w-4 h-4"></i>
        </button>
    </div>
    {% endif %}

    <!-- Import Section -->
    <form action="{{ url_for('import_saldos_bancarios') }}" method="post" enctype="multipart/form-data"
        class="bg-white p-4 rounded-lg shadow-md flex items-center gap-4">
        <input type="file" name="file" accept=".csv,.xlsx" class="border rounded px-2 py-1" required>
        <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
            Importar Arquivo
        </button>
        <a href="{{ url_for('download_saldos_template') }}" class="text-blue-600 underline" download>
            Baixar Modelo
        </a>
    </form>

    <!-- Filters -->
    <form method="POST" action="{{ url_for('saldos_bancarios') }}" class="bg-white p-6 rounded-lg shadow-md">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div>
                <label for="seq_conta" class="block text-sm font-medium text-gray-700">Conta Bancária</label>
                <select name="seq_conta" class="form-select mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                    <option value="">Todas as Contas</option>
                    {% for c in contas %}
                    <option value="{{ c.seq_conta }}" {% if seq_conta_filter==c.seq_conta %}selected{% endif %}>
                        {{ c.cod_banco }} / {{ c.num_agencia }} / {{ c.num_conta }}
                        {% if c.dsc_conta %} - {{ c.dsc_conta }}{% endif %}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label for="data_inicio" class="block text-sm font-medium text-gray-700">Data Início</label>
                <input type="date" name="data_inicio" value="{{ data_inicio_filter or '' }}"
                    class="form-input mt-1 block w-full rounded-md border-gray-300 shadow-sm">
            </div>
            <div>
                <label for="data_fim" class="block text-sm font-medium text-gray-700">Data Fim</label>
                <input type="date" name="data_fim" value="{{ data_fim_filter or '' }}"
                    class="form-input mt-1 block w-full rounded-md border-gray-300 shadow-sm">
            </div>
        </div>
        <div class="flex justify-end mt-6">
            <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg">
                Consultar
            </button>
        </div>
    </form>

    <!-- Table -->
    <div class="bg-white p-6 rounded-lg shadow-md">
        <!-- Pagination Info -->
        <div class="flex justify-between items-center mb-4">
            <span class="text-sm text-gray-600">
                Exibindo {{ ((page - 1) * per_page) + 1 if saldos else 0 }} - {{ ((page - 1) * per_page) + saldos|length }} de {{ total_count }} registros
            </span>
        </div>
        
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" onclick="sortTable('dat_saldo')">
                        Data
                        {% if sort_by == 'dat_saldo' %}
                            <i data-lucide="{{ 'arrow-up' if sort_order == 'asc' else 'arrow-down' }}" class="w-4 h-4 inline-block ml-1"></i>
                        {% endif %}
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" onclick="sortTable('seq_conta')">
                        Conta
                        {% if sort_by == 'seq_conta' %}
                            <i data-lucide="{{ 'arrow-up' if sort_order == 'asc' else 'arrow-down' }}" class="w-4 h-4 inline-block ml-1"></i>
                        {% endif %}
                    </th>
                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" onclick="sortTable('val_saldo')">
                        Saldo (R$)
                        {% if sort_by == 'val_saldo' %}
                            <i data-lucide="{{ 'arrow-up' if sort_order == 'asc' else 'arrow-down' }}" class="w-4 h-4 inline-block ml-1"></i>
                        {% endif %}
                    </th>
                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Ações
                    </th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                {% for s in saldos %}
                <tr>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">
                        {{ s.dat_saldo.strftime('%d/%m/%Y') }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800 font-medium">
                        {{ s.conta.cod_banco }} / {{ s.conta.num_agencia }} / {{ s.conta.num_conta }}
                        {% if s.conta.dsc_conta %}
                        <span class="text-gray-500">- {{ s.conta.dsc_conta }}</span>
                        {% endif %}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-right font-semibold text-green-600">
                        {{ s.val_saldo|format_currency }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-center text-sm font-medium">
                        <button type="button" class="edit-saldo-btn text-indigo-600 hover:text-indigo-900"
                            data-seq_saldo_conta="{{ s.seq_saldo_conta }}" data-seq_conta="{{ s.seq_conta }}"
                            data-dat_saldo="{{ s.dat_saldo.strftime('%Y-%m-%d') }}" data-val_saldo="{{ s.val_saldo }}">
                            <i data-lucide="edit" class="w-5 h-5"></i>
                        </button>
                        <form action="{{ url_for('delete_saldo_bancario', seq_saldo_conta=s.seq_saldo_conta) }}"
                            method="POST" class="inline-block ml-4"
                            onsubmit="return confirm('Tem certeza que deseja excluir este saldo?');">
                            <button type="submit" class="text-red-600 hover:text-red-900">
                                <i data-lucide="trash-2" class="w-5 h-5"></i>
                            </button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
                {% if not saldos %}
                <tr>
                    <td colspan="4" class="px-6 py-8 text-center text-gray-500">
                        Nenhum saldo encontrado
                    </td>
                </tr>
                {% endif %}
            </tbody>
        </table>
        
        <!-- Pagination Controls -->
        {% if total_pages > 1 %}
        <nav class="flex justify-center mt-6">
            <ul class="flex items-center space-x-1">
                <!-- First Page -->
                <li>
                    <button onclick="goToPage(1)" {% if page == 1 %}disabled{% endif %}
                        class="px-3 py-2 rounded-md {% if page == 1 %}bg-gray-100 text-gray-400 cursor-not-allowed{% else %}bg-white text-gray-700 hover:bg-gray-100{% endif %} border">
                        <i data-lucide="chevrons-left" class="w-4 h-4"></i>
                    </button>
                </li>
                <!-- Previous Page -->
                <li>
                    <button onclick="goToPage({{ page - 1 }})" {% if page == 1 %}disabled{% endif %}
                        class="px-3 py-2 rounded-md {% if page == 1 %}bg-gray-100 text-gray-400 cursor-not-allowed{% else %}bg-white text-gray-700 hover:bg-gray-100{% endif %} border">
                        <i data-lucide="chevron-left" class="w-4 h-4"></i>
                    </button>
                </li>
                
                <!-- Page Numbers -->
                {% set start_page = [page - 2, 1] | max %}
                {% set end_page = [page + 2, total_pages] | min %}
                
                {% if start_page > 1 %}
                <li><span class="px-2 text-gray-500">...</span></li>
                {% endif %}
                
                {% for p in range(start_page, end_page + 1) %}
                <li>
                    <button onclick="goToPage({{ p }})"
                        class="px-4 py-2 rounded-md border {% if p == page %}bg-blue-600 text-white{% else %}bg-white text-gray-700 hover:bg-gray-100{% endif %}">
                        {{ p }}
                    </button>
                </li>
                {% endfor %}
                
                {% if end_page < total_pages %}
                <li><span class="px-2 text-gray-500">...</span></li>
                {% endif %}
                
                <!-- Next Page -->
                <li>
                    <button onclick="goToPage({{ page + 1 }})" {% if page == total_pages %}disabled{% endif %}
                        class="px-3 py-2 rounded-md {% if page == total_pages %}bg-gray-100 text-gray-400 cursor-not-allowed{% else %}bg-white text-gray-700 hover:bg-gray-100{% endif %} border">
                        <i data-lucide="chevron-right" class="w-4 h-4"></i>
                    </button>
                </li>
                <!-- Last Page -->
                <li>
                    <button onclick="goToPage({{ total_pages }})" {% if page == total_pages %}disabled{% endif %}
                        class="px-3 py-2 rounded-md {% if page == total_pages %}bg-gray-100 text-gray-400 cursor-not-allowed{% else %}bg-white text-gray-700 hover:bg-gray-100{% endif %} border">
                        <i data-lucide="chevrons-right" class="w-4 h-4"></i>
                    </button>
                </li>
            </ul>
        </nav>
        {% endif %}
    </div>
</div>

<!-- Hidden form for pagination and sorting -->
<form id="pagination-form" method="POST" action="{{ url_for('saldos_bancarios') }}" style="display: none;">
    <input type="hidden" name="seq_conta" value="{{ seq_conta_filter or '' }}">
    <input type="hidden" name="data_inicio" value="{{ data_inicio_filter or '' }}">
    <input type="hidden" name="data_fim" value="{{ data_fim_filter or '' }}">
    <input type="hidden" name="page" id="page-input" value="{{ page }}">
    <input type="hidden" name="sort_by" id="sort-by-input" value="{{ sort_by }}">
    <input type="hidden" name="sort_order" id="sort-order-input" value="{{ sort_order }}">
</form>

<!-- Modal de Novo Saldo -->
<div id="novo-saldo-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden">
    <div class="relative top-20 mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
        <div class="flex justify-between items-center pb-3 border-b">
            <h3 class="text-2xl font-bold text-gray-800">Novo Saldo Bancário</h3>
            <button id="close-novo-modal-btn" class="text-gray-500 hover:text-gray-800">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>
        </div>
        <div class="mt-5">
            <form id="novo-saldo-form" action="{{ url_for('add_saldo_bancario') }}" method="POST">
                <div class="space-y-4">
                    <div>
                        <label for="novo_seq_conta" class="block text-sm font-medium text-gray-700">Conta
                            Bancária</label>
                        <select name="seq_conta" id="novo_seq_conta"
                            class="form-select mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
                            <option value="">Selecione uma conta...</option>
                            {% for c in contas %}
                            <option value="{{ c.seq_conta }}">
                                {{ c.cod_banco }} / {{ c.num_agencia }} / {{ c.num_conta }}
                                {% if c.dsc_conta %} - {{ c.dsc_conta }}{% endif %}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div>
                        <label for="novo_dat_saldo" class="block text-sm font-medium text-gray-700">Data</label>
                        <input type="date" name="dat_saldo" id="novo_dat_saldo"
                            class="form-input mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
                    </div>
                    <div>
                        <label for="novo_val_saldo" class="block text-sm font-medium text-gray-700">Saldo (R$)</label>
                        <input type="number" step="0.01" name="val_saldo" id="novo_val_saldo"
                            class="form-input mt-1 block w-full rounded-md border-gray-300 shadow-sm" placeholder="0.00"
                            required>
                    </div>
                </div>
                <div class="flex justify-end mt-6 gap-3">
                    <button type="button" id="cancel-novo-btn"
                        class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-6 rounded-lg">
                        Cancelar
                    </button>
                    <button type="submit"
                        class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg">
                        Salvar
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal de Editar Saldo -->
<div id="edit-saldo-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden">
    <div class="relative top-20 mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
        <div class="flex justify-between items-center pb-3 border-b">
            <h3 class="text-2xl font-bold text-gray-800">Editar Saldo Bancário</h3>
            <button id="close-edit-modal-btn" class="text-gray-500 hover:text-gray-800">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>
        </div>
        <div class="mt-5">
            <form id="edit-saldo-form" action="" method="POST">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Conta Bancária</label>
                        <input type="text" id="edit_conta_display" readonly
                            class="form-input mt-1 block w-full rounded-md border-gray-300 bg-gray-50">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Data</label>
                        <input type="text" id="edit_dat_display" readonly
                            class="form-input mt-1 block w-full rounded-md border-gray-300 bg-gray-50">
                    </div>
                    <div>
                        <label for="edit_val_saldo" class="block text-sm font-medium text-gray-700">Saldo (R$)</label>
                        <input type="number" step="0.01" name="val_saldo" id="edit_val_saldo"
                            class="form-input mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
                    </div>
                </div>
                <div class="flex justify-end mt-6 gap-3">
                    <button type="button" id="cancel-edit-btn"
                        class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-6 rounded-lg">
                        Cancelar
                    </button>
                    <button type="submit"
                        class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg">
                        Salvar Alterações
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    // Pagination function
    function goToPage(pageNum) {
        document.getElementById('page-input').value = pageNum;
        document.getElementById('pagination-form').submit();
    }
    
    // Sorting function
    function sortTable(column) {
        const currentSortBy = '{{ sort_by }}';
        const currentSortOrder = '{{ sort_order }}';
        
        let newSortOrder = 'asc';
        if (column === currentSortBy) {
            newSortOrder = currentSortOrder === 'asc' ? 'desc' : 'asc';
        }
        
        document.getElementById('sort-by-input').value = column;
        document.getElementById('sort-order-input').value = newSortOrder;
        document.getElementById('page-input').value = 1; // Reset to page 1 when sorting
        document.getElementById('pagination-form').submit();
    }

    document.addEventListener('DOMContentLoaded', function () {
        // Modal de Novo Saldo
        const novoSaldoBtn = document.getElementById('novo-saldo-btn');
        const novoModal = document.getElementById('novo-saldo-modal');
        const closeNovoModalBtn = document.getElementById('close-novo-modal-btn');
        const cancelNovoBtn = document.getElementById('cancel-novo-btn');

        if (novoSaldoBtn) {
            novoSaldoBtn.addEventListener('click', () => novoModal.classList.remove('hidden'));
        }
        if (closeNovoModalBtn) {
            closeNovoModalBtn.addEventListener('click', () => novoModal.classList.add('hidden'));
        }
        if (cancelNovoBtn) {
            cancelNovoBtn.addEventListener('click', () => novoModal.classList.add('hidden'));
        }

        // Modal de Edição
        const editModal = document.getElementById('edit-saldo-modal');
        const closeEditModalBtn = document.getElementById('close-edit-modal-btn');
        const cancelEditBtn = document.getElementById('cancel-edit-btn');
        const editForm = document.getElementById('edit-saldo-form');
        const editButtons = document.querySelectorAll('.edit-saldo-btn');

        // Build contas map from server data
        const contasData = {{ contas| tojson | safe
    }};
    const contasMap = {};
    if (Array.isArray(contasData)) {
        contasData.forEach(c => {
            const contaLabel = c.cod_banco + ' / ' + c.num_agencia + ' / ' + c.num_conta + (c.dsc_conta ? ' - ' + c.dsc_conta : '');
            contasMap[c.seq_conta] = contaLabel;
        });
    }

    editButtons.forEach(button => {
        button.addEventListener('click', () => {
            const seq = button.dataset.seq_saldo_conta;
            const seqConta = button.dataset.seq_conta;
            const datSaldo = button.dataset.dat_saldo;
            const valSaldo = button.dataset.val_saldo;

            editForm.action = `/saldos-bancarios/${seq}/editar`;
            document.getElementById('edit_conta_display').value = contasMap[seqConta] || '';
            // Format date without timezone conversion (datSaldo is YYYY-MM-DD)
            const [year, month, day] = datSaldo.split('-');
            document.getElementById('edit_dat_display').value = `${day}/${month}/${year}`;
            document.getElementById('edit_val_saldo').value = valSaldo;

            editModal.classList.remove('hidden');
        });
    });

    const closeEditModal = () => {
        if (editModal) editModal.classList.add('hidden');
    };

    if (closeEditModalBtn) closeEditModalBtn.addEventListener('click', closeEditModal);
    if (cancelEditBtn) cancelEditBtn.addEventListener('click', closeEditModal);

    // Close modals on outside click
    window.addEventListener('click', (event) => {
        if (event.target === novoModal) novoModal.classList.add('hidden');
        if (event.target === editModal) editModal.classList.add('hidden');
    });
    });
</script>
{% endblock %}