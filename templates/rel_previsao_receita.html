{% extends 'base.html' %}
{% block content %}
<div class="flex items-center justify-between mb-6">
    <div class="flex items-center">
        <a href="{{ url_for('relatorios') }}" class="text-gray-500 hover:text-gray-700">
            <i data-lucide="arrow-left-circle" class="w-8 h-8"></i>
        </a>
        <h2 class="text-2xl font-bold text-gray-800 ml-4">Previsão de Receita</h2>
    </div>
</div>

<!-- Descrição -->
<div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-6 rounded-r-lg">
    <div class="flex items-start">
        <div class="flex-shrink-0">
            <i data-lucide="info" class="w-5 h-5 text-blue-600"></i>
        </div>
        <div class="ml-3">
            <p class="text-sm text-blue-700">
                Compare o histórico de receitas arrecadadas com as projeções baseadas em cenários econômicos.
                Selecione as fontes de receita e o cenário desejado para visualizar a evolução mensal e composição
                anual.
            </p>
        </div>
    </div>
</div>

<!-- Filtros -->
<div class="bg-white p-6 rounded-lg shadow-md mb-6">
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <!-- Seleção de Ano -->
        <div>
            <label for="ano" class="block text-sm font-medium text-gray-700 mb-1">Ano</label>
            <select name="ano" id="ano"
                class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                {% for ano in anos_disponiveis %}
                <option value="{{ ano }}" {% if ano==ano_default %}selected{% endif %}>{{ ano }}</option>
                {% endfor %}
            </select>
        </div>

        <!-- Seleção de Cenário -->
        <div>
            <label for="cenario" class="block text-sm font-medium text-gray-700 mb-1">Cenário de Projeção</label>
            <select name="cenario" id="cenario"
                class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                <option value="">Sem Projeção (Apenas Realizado)</option>
                {% for cenario in cenarios %}
                <option value="{{ cenario.seq_simulador_cenario }}">{{ cenario.nom_cenario }}</option>
                {% endfor %}
            </select>
        </div>

        <!-- Qualificador Receita (Dropdown Multi-Select) -->
        <div class="relative">
            <label class="block text-sm font-medium text-gray-700 mb-1">Qualificador Receita</label>
            <button type="button" id="qualificador-dropdown-btn" class="multiselect-button">
                <span id="qualificador-selected-text">{{ qualificadores|length }} selecionados</span>
                <i data-lucide="chevron-down" class="h-4 w-4 opacity-50"></i>
            </button>
            <div id="qualificador-dropdown" class="multiselect-dropdown hidden shadow-lg max-h-60 overflow-y-auto">
                {% for q in qualificadores %}
                <label class="flex items-center text-sm">
                    <input type="checkbox" class="qualificador-checkbox h-4 w-4 rounded border-gray-300"
                        value="{{ q.seq_qualificador }}" checked>
                    <span class="ml-2">{{ q.dsc_qualificador }}</span>
                </label>
                {% endfor %}
            </div>
        </div>

        <!-- Botão de Atualização -->
        <div class="flex items-end">
            <button type="button" id="btn-atualizar"
                class="w-full px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:ring-4 focus:ring-blue-300 flex items-center justify-center">
                <i data-lucide="refresh-cw" class="w-4 h-4 mr-2"></i>
                Atualizar Gráficos
            </button>
        </div>
    </div>
</div>

<!-- Loading Indicator -->
<div id="loading" class="hidden bg-white p-8 rounded-lg shadow-md mb-6">
    <div class="flex items-center justify-center">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
        <span class="ml-4 text-gray-600">Carregando dados...</span>
    </div>
</div>

<!-- Gráficos - Proporção 60/40% -->
<div id="graficos-container" class="grid grid-cols-1 lg:grid-cols-5 gap-6">
    <!-- Gráfico de Evolução Mensal (60%) -->
    <div class="lg:col-span-3 bg-white p-6 rounded-lg shadow-md">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-semibold text-gray-700">Evolução Mensal</h3>
            <div class="flex items-center gap-4 text-sm text-gray-500">
                <span class="flex items-center gap-1">
                    <div class="w-3 h-3 bg-blue-600 rounded-full"></div> Realizado
                </span>
                <span class="flex items-center gap-1">
                    <div class="w-3 h-3 border-2 border-purple-600 rounded-full"></div> Previsão
                </span>
            </div>
        </div>
        <div class="relative h-96">
            <canvas id="evolucaoChart"></canvas>
        </div>
    </div>

    <!-- Gráfico de Composição Anual (40%) -->
    <div class="lg:col-span-2 bg-white p-6 rounded-lg shadow-md">
        <h3 class="text-lg font-semibold text-gray-700 mb-2">Composição Anual</h3>
        <p class="text-xs text-gray-400 mb-4">Acumulado: Realizado vs Projetado</p>
        <div class="relative h-96">
            <canvas id="composicaoChart"></canvas>
        </div>
    </div>
</div>

<style>
    .multiselect-button {
        background-color: white;
        border: 1px solid #d1d5db;
        border-radius: 0.375rem;
        padding: 0.5rem 0.75rem;
        width: 100%;
        text-align: left;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .multiselect-dropdown {
        position: absolute;
        background-color: white;
        border: 1px solid #d1d5db;
        border-radius: 0.375rem;
        width: 100%;
        z-index: 10;
        margin-top: 0.25rem;
    }

    .multiselect-dropdown label {
        display: block;
        padding: 0.5rem 0.75rem;
        cursor: pointer;
    }

    .multiselect-dropdown label:hover {
        background-color: #f3f4f6;
    }
</style>

{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Cores para as fontes de receita
        const CORES_FONTES = [
            '#3B82F6', '#8B5CF6', '#10B981', '#F59E0B',
            '#EF4444', '#64748B', '#EC4899', '#14B8A6',
        ];

        // Setup do dropdown multi-select
        const qualificadorBtn = document.getElementById('qualificador-dropdown-btn');
        const qualificadorDropdown = document.getElementById('qualificador-dropdown');
        const qualificadorCheckboxes = document.querySelectorAll('.qualificador-checkbox');
        const qualificadorText = document.getElementById('qualificador-selected-text');

        function updateQualificadorText() {
            const selected = Array.from(qualificadorCheckboxes).filter(cb => cb.checked);
            if (selected.length === 0) qualificadorText.textContent = 'Selecione';
            else if (selected.length === 1) {
                qualificadorText.textContent = selected[0].parentElement.querySelector('span').textContent;
            }
            else qualificadorText.textContent = `${selected.length} selecionados`;
        }

        qualificadorBtn.addEventListener('click', e => {
            e.stopPropagation();
            qualificadorDropdown.classList.toggle('hidden');
        });

        document.addEventListener('click', e => {
            if (!qualificadorDropdown.contains(e.target) && !qualificadorBtn.contains(e.target)) {
                qualificadorDropdown.classList.add('hidden');
            }
        });

        qualificadorCheckboxes.forEach(cb => {
            cb.addEventListener('change', updateQualificadorText);
        });

        updateQualificadorText();

        // Variáveis dos gráficos
        let evolucaoChart = null;
        let composicaoChart = null;

        // Função para carregar dados
        async function carregarDados() {
            const ano = document.getElementById('ano').value;
            const cenario = document.getElementById('cenario').value;

            const qualificadores = Array.from(qualificadorCheckboxes)
                .filter(cb => cb.checked)
                .map(cb => cb.value);

            if (qualificadores.length === 0) {
                alert('Selecione pelo menos um qualificador de receita');
                return;
            }

            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('graficos-container').classList.add('opacity-50');

            try {
                const params = new URLSearchParams({
                    ano: ano,
                    qualificadores: qualificadores.join(',')
                });

                if (cenario) params.append('cenario', cenario);

                const response = await fetch(`{{ url_for('relatorio_previsao_receita_data') }}?${params}`);
                const data = await response.json();

                atualizarGraficoEvolucao(data);
                atualizarGraficoComposicao(data);

            } catch (error) {
                console.error('Erro ao carregar dados:', error);
                alert('Erro ao carregar dados. Tente novamente.');
            } finally {
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('graficos-container').classList.remove('opacity-50');
            }
        }

        function atualizarGraficoEvolucao(data) {
            const ctx = document.getElementById('evolucaoChart').getContext('2d');
            if (evolucaoChart) evolucaoChart.destroy();

            const labels = data.evolucao_mensal.map(d => d.mes);
            const realizados = data.evolucao_mensal.map(d => d.realizado);
            const previsoes = data.evolucao_mensal.map(d => d.previsao);

            evolucaoChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Realizado',
                            data: realizados,
                            backgroundColor: 'rgba(37, 99, 235, 0.1)',
                            borderColor: '#2563EB',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.3,
                            pointRadius: 4,
                            pointBackgroundColor: '#2563EB',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2
                        },
                        {
                            label: 'Previsão Cenário',
                            data: previsoes,
                            backgroundColor: 'rgba(147, 51, 234, 0.1)',
                            borderColor: '#9333EA',
                            borderWidth: 3,
                            borderDash: [5, 5],
                            fill: false,
                            tension: 0.3,
                            pointRadius: 4,
                            pointBackgroundColor: '#9333EA',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { intersect: false, mode: 'index' },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    let label = context.dataset.label || '';
                                    if (label) label += ': ';
                                    if (context.parsed.y !== null) {
                                        label += new Intl.NumberFormat('pt-BR', {
                                            style: 'currency',
                                            currency: 'BRL'
                                        }).format(context.parsed.y);
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        x: { grid: { display: false } },
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function (value) {
                                    return 'R$ ' + (value / 1000000).toFixed(1) + 'M';
                                }
                            },
                            grid: { color: 'rgba(0, 0, 0, 0.05)' }
                        }
                    }
                },
                plugins: [{
                    afterDatasetsDraw: function (chart) {
                        const mes_atual = data.mes_atual;
                        if (mes_atual > 0 && mes_atual <= 12) {
                            const meta = chart.getDatasetMeta(0);
                            const dataPoint = meta.data[mes_atual - 1];

                            if (dataPoint) {
                                const ctx = chart.ctx;
                                const x = dataPoint.x;
                                const yAxis = chart.scales.y;

                                ctx.save();
                                ctx.strokeStyle = '#94A3B8';
                                ctx.lineWidth = 1;
                                ctx.setLineDash([3, 3]);
                                ctx.beginPath();
                                ctx.moveTo(x, yAxis.top);
                                ctx.lineTo(x, yAxis.bottom);
                                ctx.stroke();

                                ctx.fillStyle = '#94A3B8';
                                ctx.font = 'bold 11px Arial';
                                ctx.fillText('Hoje', x + 5, yAxis.top + 15);
                                ctx.restore();
                            }
                        }
                    }
                }]
            });
        }

        function atualizarGraficoComposicao(data) {
            const ctx = document.getElementById('composicaoChart').getContext('2d');
            if (composicaoChart) composicaoChart.destroy();

            const labels = data.composicao_anual.map(d => d.qualificador_nome);
            const realizados = data.composicao_anual.map(d => d.realizado_total);
            const previsoes = data.composicao_anual.map(d => d.previsao_total);
            const cores = data.composicao_anual.map((_, index) => CORES_FONTES[index % CORES_FONTES.length]);

            composicaoChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Projeção',
                            data: previsoes,
                            backgroundColor: '#E2E8F0',
                            borderRadius: 4,
                            barThickness: 16
                        },
                        {
                            label: 'Realizado',
                            data: realizados,
                            backgroundColor: cores,
                            borderRadius: 4,
                            barThickness: 16
                        }
                    ]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: true, position: 'top' },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    let label = context.dataset.label || '';
                                    if (label) label += ': ';
                                    label += new Intl.NumberFormat('pt-BR', {
                                        style: 'currency',
                                        currency: 'BRL'
                                    }).format(context.parsed.x);
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: {
                                callback: function (value) {
                                    return 'R$ ' + (value / 1000000).toFixed(1) + 'M';
                                }
                            },
                            grid: { display: false }
                        },
                        y: { grid: { display: false } }
                    }
                }
            });
        }

        document.getElementById('btn-atualizar').addEventListener('click', carregarDados);
        carregarDados();
    });
</script>
{% endblock %}