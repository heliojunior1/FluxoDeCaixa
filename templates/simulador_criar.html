{% extends 'base.html' %}

{% block content %}
<div class="bg-white p-6 rounded-lg shadow-md border">
    <div class="flex items-center justify-between mb-6">
        <div class="flex items-center">
            <a href="{{ url_for('simulador_menu') }}" class="text-blue-600 hover:text-blue-800 mr-4">
                <i data-lucide="arrow-left-circle" class="h-6 w-6"></i>
            </a>
            <h2 class="text-2xl font-semibold text-gray-700">
                {% if modo == 'editar' %}Editar Cenário{% else %}Novo Cenário{% endif %}
            </h2>
        </div>
    </div>

    <form
        action="{% if modo == 'editar' %}/simulador/{{ simulador.seq_simulador_cenario }}/atualizar{% else %}/simulador/criar{% endif %}"
        method="POST" id="form-cenario"
        data-cenario='{{ cenario_completo | tojson | safe if cenario_completo else "" }}'>

        <!-- 1. Dados Básicos -->
        <div class="mb-8 p-4 bg-gray-50 rounded-lg border">
            <h3 class="text-lg font-medium text-gray-800 mb-4 flex items-center gap-2">
                <i data-lucide="file-text" class="h-5 w-5 text-blue-600"></i>
                Dados Básicos
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Nome do Cenário</label>
                    <input type="text" name="nom_cenario" required
                        class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border"
                        value="{{ simulador.nom_cenario if simulador else '' }}">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Descrição</label>
                    <input type="text" name="dsc_cenario"
                        class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border"
                        value="{{ simulador.dsc_cenario if simulador else '' }}">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Ano Base</label>
                    <input type="number" name="ano_base" required
                        class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border"
                        value="{{ simulador.ano_base if simulador else current_year }}">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Meses de Projeção</label>
                    <input type="number" name="meses_projecao" required min="1" max="60"
                        class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border"
                        value="{{ simulador.meses_projecao if simulador else 12 }}">
                </div>
            </div>
        </div>

        <!-- 2. Configuração de Receita -->
        <div class="mb-8 p-4 bg-green-50 rounded-lg border border-green-100">
            <h3 class="text-lg font-medium text-green-800 mb-4 flex items-center gap-2">
                <i data-lucide="trending-up" class="h-5 w-5"></i>
                Projeção de Receita
            </h3>

            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">Método de Projeção</label>
                <select name="tipo_cenario_receita" id="tipo_receita"
                    class="w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500 p-2 border"
                    onchange="toggleReceitaFields()">
                    <option value="MANUAL" {% if cenario_completo and
                        cenario_completo.receita.config.cod_tipo_cenario=='MANUAL' %}selected{% endif %}>Manual (Ajustes
                        Mensais)</option>
                    <option value="HOLT_WINTERS" {% if cenario_completo and
                        cenario_completo.receita.config.cod_tipo_cenario=='HOLT_WINTERS' %}selected{% endif %}>
                        Holt-Winters (Sazonalidade + Tendência)</option>
                    <option value="ARIMA" {% if cenario_completo and
                        cenario_completo.receita.config.cod_tipo_cenario=='ARIMA' %}selected{% endif %}>ARIMA
                        (Auto-Regressivo)</option>
                    <option value="SARIMA" {% if cenario_completo and
                        cenario_completo.receita.config.cod_tipo_cenario=='SARIMA' %}selected{% endif %}>SARIMA (ARIMA
                        Sazonal)</option>
                    <option value="REGRESSAO" {% if cenario_completo and
                        cenario_completo.receita.config.cod_tipo_cenario=='REGRESSAO' %}selected{% endif %}>Regressão
                        Linear Múltipla</option>
                </select>
            </div>

            <!-- Campos Específicos de Modelo (Receita) -->
            <div id="receita_model_fields" class="mb-4 hidden space-y-4 p-4 bg-white rounded border">
                <h4 class="font-medium text-gray-700">Configuração do Modelo</h4>

                <!-- Seleção de Qualificadores para aplicar o Modelo -->
                <div id="common_model_params">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Selecione os Qualificadores para Projeção
                        <span class="text-xs text-gray-500 ml-2">(cada um será calculado com seus próprios dados históricos)</span>
                    </label>
                    
                    <!-- Botões de seleção rápida -->
                    <div class="flex gap-2 mb-2">
                        <button type="button" onclick="toggleTodosQualificadores(true)" 
                            class="text-xs px-2 py-1 bg-blue-100 text-blue-700 rounded hover:bg-blue-200">
                            Selecionar Todos
                        </button>
                        <button type="button" onclick="toggleTodosQualificadores(false)" 
                            class="text-xs px-2 py-1 bg-gray-100 text-gray-700 rounded hover:bg-gray-200">
                            Desmarcar Todos
                        </button>
                    </div>
                    
                    <!-- Lista de qualificadores com checkboxes -->
                    <div id="qualificadores_list" class="max-h-48 overflow-y-auto border rounded p-2 bg-gray-50 grid grid-cols-2 md:grid-cols-3 gap-1">
                        {% for q in qualificadores_receita %}
                        <label class="flex items-center gap-2 p-1 hover:bg-gray-100 rounded cursor-pointer text-sm">
                            <input type="checkbox" class="qualificador-checkbox" value="{{ q.seq_qualificador }}" 
                                data-nome="{{ q.dsc_qualificador }}">
                            <span class="truncate" title="{{ q.dsc_qualificador }}">{{ q.dsc_qualificador }}</span>
                        </label>
                        {% endfor %}
                    </div>
                    
                    <p class="text-xs text-gray-500 mt-1">
                        <span id="qualificadores_count">0</span> qualificador(es) selecionado(s)
                    </p>
                    
                    <!-- Hidden input para seq_qualificadores -->
                    <input type="hidden" name="receita_config_seq_qualificadores" id="receita_seq_qualificadores_hidden">
                </div>

                <!-- Parâmetros Holt-Winters -->
                <div id="hw_params" class="model-params hidden">
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div>
                            <label class="block text-xs font-medium text-gray-600">Período Sazonal</label>
                            <input type="number" name="receita_config_seasonal_periods" value="12"
                                class="w-full border rounded p-1" min="2" max="24">
                            <p class="text-xs text-gray-400 mt-1">Normalmente 12 para dados mensais</p>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-600">Tendência</label>
                            <select name="receita_config_trend" class="w-full border rounded p-1">
                                <option value="add">Aditiva</option>
                                <option value="mul">Multiplicativa</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-600">Sazonalidade</label>
                            <select name="receita_config_seasonal" class="w-full border rounded p-1">
                                <option value="add">Aditiva</option>
                                <option value="mul">Multiplicativa</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-600">Amortecimento</label>
                            <select name="receita_config_damped_trend" class="w-full border rounded p-1">
                                <option value="false">Não</option>
                                <option value="true">Sim</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Parâmetros ARIMA -->
                <div id="arima_params" class="model-params hidden">
                    <p class="text-xs text-gray-500 mb-2">ARIMA(p,d,q) - Modelo Auto-Regressivo Integrado de Média Móvel</p>
                    <div class="grid grid-cols-3 md:grid-cols-4 gap-4">
                        <div>
                            <label class="block text-xs font-medium text-gray-600">p (Auto-Regressivo)</label>
                            <input type="number" name="receita_config_p" value="1" min="0" max="5"
                                class="w-full border rounded p-1">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-600">d (Diferenciação)</label>
                            <input type="number" name="receita_config_d" value="1" min="0" max="2"
                                class="w-full border rounded p-1">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-600">q (Média Móvel)</label>
                            <input type="number" name="receita_config_q" value="1" min="0" max="5"
                                class="w-full border rounded p-1">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-600">Auto-seleção</label>
                            <select name="receita_config_auto_order" class="w-full border rounded p-1">
                                <option value="false">Manual</option>
                                <option value="true">Automático</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Parâmetros SARIMA -->
                <div id="sarima_params" class="model-params hidden">
                    <p class="text-xs text-gray-500 mb-2">SARIMA(p,d,q)(P,D,Q,s) - ARIMA Sazonal</p>
                    <div class="grid grid-cols-3 md:grid-cols-4 gap-4 mb-3">
                        <div>
                            <label class="block text-xs font-medium text-gray-600">p (AR)</label>
                            <input type="number" name="receita_config_p" value="1" min="0" max="3"
                                class="w-full border rounded p-1">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-600">d (I)</label>
                            <input type="number" name="receita_config_d" value="1" min="0" max="2"
                                class="w-full border rounded p-1">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-600">q (MA)</label>
                            <input type="number" name="receita_config_q" value="1" min="0" max="3"
                                class="w-full border rounded p-1">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-600">s (Período)</label>
                            <input type="number" name="receita_config_s" value="12" min="2" max="24"
                                class="w-full border rounded p-1">
                        </div>
                    </div>
                    <p class="text-xs text-gray-500 mb-2">Parâmetros Sazonais:</p>
                    <div class="grid grid-cols-3 gap-4">
                        <div>
                            <label class="block text-xs font-medium text-gray-600">P (AR Sazonal)</label>
                            <input type="number" name="receita_config_P" value="1" min="0" max="2"
                                class="w-full border rounded p-1">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-600">D (I Sazonal)</label>
                            <input type="number" name="receita_config_D" value="1" min="0" max="1"
                                class="w-full border rounded p-1">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-600">Q (MA Sazonal)</label>
                            <input type="number" name="receita_config_Q" value="1" min="0" max="2"
                                class="w-full border rounded p-1">
                        </div>
                    </div>
                </div>

                <!-- Parâmetros Regressão Linear -->
                <div id="regressao_params" class="model-params hidden space-y-3">
                    <p class="text-sm text-gray-600 font-mono bg-gray-50 p-2 rounded">Fórmula: Receita = β0 + (β1 × PIB)
                        + (β2 × Inflação)</p>
                    <div class="grid grid-cols-3 gap-4">
                        <div>
                            <label class="block text-xs font-medium text-gray-600">β0 (Intercepto)</label>
                            <input type="number" step="0.0001" name="receita_config_beta0" id="reg_beta0"
                                class="w-full border rounded p-1" placeholder="0.00">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-600">β1 (PIB)</label>
                            <input type="number" step="0.0001" name="receita_config_beta1" id="reg_beta1"
                                class="w-full border rounded p-1" placeholder="0.00">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-600">β2 (Inflação)</label>
                            <input type="number" step="0.0001" name="receita_config_beta2" id="reg_beta2"
                                class="w-full border rounded p-1" placeholder="0.00">
                        </div>
                    </div>
                    <!-- Inputs para valores projetados das variáveis -->
                    <div class="mt-2">
                        <label class="block text-xs font-medium text-gray-600 mb-1">Valores Projetados (Média
                            Mensal)</label>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="text-xs text-gray-500">PIB</label>
                                <input type="number" step="0.01" name="receita_config_val_pib" id="reg_val_pib"
                                    class="w-full border rounded p-1" placeholder="Valor PIB">
                            </div>
                            <div>
                                <label class="text-xs text-gray-500">Inflação</label>
                                <input type="number" step="0.01" name="receita_config_val_inflacao"
                                    id="reg_val_inflacao" class="w-full border rounded p-1"
                                    placeholder="Valor Inflação">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mt-4 flex justify-end gap-2">
                    <span id="projecao_status" class="text-sm text-gray-500 self-center"></span>
                    <button type="button" onclick="aplicarModeloReceita()"
                        class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 text-sm flex items-center gap-2">
                        <i data-lucide="play"></i> Calcular e Preencher Tabela
                    </button>
                </div>
            </div>

            <!-- Tabela de Valores Receita (Sempre Visível) -->
            <div id="receita_manual_fields">
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white text-sm border">
                        <thead>
                            <tr class="bg-green-100">
                                <th class="p-2 text-left border-r min-w-[200px]">Qualificador</th>
                                <th class="p-2 text-center border-r bg-green-200 min-w-[250px]">Aplicar a Todos</th>
                                {% for mes_num, mes_nome in meses_nomes.items() %}
                                <th class="p-2 text-center min-w-[100px]">{{ mes_nome[:3] }}</th>
                                {% endfor %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for qualificador in qualificadores_receita %}
                            <tr class="border-b hover:bg-gray-50" data-row-id="rec-{{ qualificador.seq_qualificador }}">
                                <td class="p-2 font-medium border-r">{{ qualificador.dsc_qualificador }}</td>
                                <!-- Coluna Aplicar a Todos -->
                                <td class="p-2 border-r bg-gray-50">
                                    <div class="flex items-center gap-1">
                                        <select class="text-xs border rounded p-1 w-12"
                                            id="tipo_apply_rec_{{ qualificador.seq_qualificador }}">
                                            <option value="P">%</option>
                                            <option value="V">R$</option>
                                        </select>
                                        <input type="number" step="0.01" class="text-xs border rounded p-1 w-20"
                                            id="val_apply_rec_{{ qualificador.seq_qualificador }}" placeholder="Valor">
                                        <button type="button"
                                            onclick="aplicarTodos('rec', {{ qualificador.seq_qualificador }})"
                                            class="bg-blue-100 text-blue-600 p-1 rounded hover:bg-blue-200"
                                            title="Aplicar">
                                            <i data-lucide="arrow-right" class="h-4 w-4"></i>
                                        </button>
                                    </div>
                                </td>
                                <!-- Meses -->
                                {% for mes_num, mes_nome in meses_nomes.items() %}
                                <td class="p-1 text-center">
                                    <div class="flex flex-col gap-1">
                                        <select name="cod_tipo_ajuste_{{ mes_num }}_{{ qualificador.seq_qualificador }}"
                                            class="text-[10px] border rounded p-0.5 w-full bg-gray-50">
                                            <option value="P">%</option>
                                            <option value="V">R$</option>
                                        </select>
                                        <input type="number" step="0.01"
                                            name="val_ajuste_{{ mes_num }}_{{ qualificador.seq_qualificador }}"
                                            class="w-full text-xs p-1 border rounded text-right" placeholder="0.00">
                                    </div>
                                </td>
                                {% endfor %}
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- 3. Configuração de Despesa -->
        <div class="mb-8 p-4 bg-red-50 rounded-lg border border-red-100">
            <h3 class="text-lg font-medium text-red-800 mb-4 flex items-center gap-2">
                <i data-lucide="trending-down" class="h-5 w-5"></i>
                Projeção de Despesa
            </h3>

            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">Método de Projeção</label>
                <select name="tipo_cenario_despesa" id="tipo_despesa"
                    class="w-full rounded-md border-gray-300 shadow-sm focus:border-red-500 focus:ring-red-500 p-2 border"
                    onchange="toggleDespesaFields()">
                    <option value="MANUAL" {% if cenario_completo and
                        cenario_completo.despesa.config.cod_tipo_cenario=='MANUAL' %}selected{% endif %}>Manual (Ajustes
                        Mensais)</option>
                    <option value="LOA" {% if cenario_completo and
                        cenario_completo.despesa.config.cod_tipo_cenario=='LOA' %}selected{% endif %}>LOA (Lei
                        Orçamentária Anual)</option>
                    <option value="MEDIA_HISTORICA" {% if cenario_completo and
                        cenario_completo.despesa.config.cod_tipo_cenario=='MEDIA_HISTORICA' %}selected{% endif %}>Média
                        Histórica Ajustada</option>
                </select>
            </div>

            <!-- Configuração LOA (Tabela Anual) -->
            <div id="despesa_loa_fields" class="hidden mb-4 p-4 bg-white rounded border">
                <h4 class="font-medium text-gray-700 mb-2">Valores Anuais (LOA)</h4>
                <p class="text-xs text-gray-500 mb-4">Preencha o valor total anual para cada qualificador. O sistema
                    distribuirá uniformemente pelos meses.</p>
                <div class="overflow-x-auto max-h-60 mb-4">
                    <table class="min-w-full text-sm">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="p-2 text-left">Qualificador</th>
                                <th class="p-2 text-right">Valor Total Anual (R$)</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for q in qualificadores_despesa %}
                            <tr class="border-b">
                                <td class="p-2">{{ q.dsc_qualificador }}</td>
                                <td class="p-2">
                                    <input type="number" step="0.01"
                                        class="w-full border rounded p-1 text-right loa-input"
                                        id="loa_val_{{ q.seq_qualificador }}" data-seq="{{ q.seq_qualificador }}"
                                        placeholder="0.00">
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <div class="flex justify-end">
                    <button type="button" onclick="aplicarLOA()"
                        class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700 text-sm flex items-center gap-2">
                        <i data-lucide="check"></i> Aplicar Valores LOA na Tabela
                    </button>
                </div>
            </div>

            <!-- Configuração Média Histórica -->
            <div id="despesa_media_fields" class="hidden mb-4 p-4 bg-white rounded border">
                <h4 class="font-medium text-gray-700 mb-2">Configuração Média Histórica</h4>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Período Base (Meses)</label>
                        <input type="number" name="despesa_config_periodo_meses" value="12"
                            class="w-full border rounded p-2">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Fator de Ajuste (ex: 1.05 =
                            +5%)</label>
                        <input type="number" step="0.01" name="despesa_config_fator_ajuste" value="1.00"
                            class="w-full border rounded p-2">
                    </div>
                </div>
                <div class="mt-4 flex justify-end">
                    <button type="button" onclick="aplicarMediaHistorica()"
                        class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700 text-sm flex items-center gap-2">
                        <i data-lucide="play"></i> Calcular e Preencher Tabela
                    </button>
                </div>
            </div>

            <!-- Tabela de Valores Despesa (Sempre Visível) -->
            <div id="despesa_manual_fields">
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white text-sm border">
                        <thead>
                            <tr class="bg-red-100">
                                <th class="p-2 text-left border-r min-w-[200px]">Qualificador</th>
                                <th class="p-2 text-center border-r bg-red-200 min-w-[250px]">Aplicar a Todos</th>
                                {% for mes_num, mes_nome in meses_nomes.items() %}
                                <th class="p-2 text-center min-w-[100px]">{{ mes_nome[:3] }}</th>
                                {% endfor %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for qualificador in qualificadores_despesa %}
                            <tr class="border-b hover:bg-gray-50"
                                data-row-id="desp-{{ qualificador.seq_qualificador }}">
                                <td class="p-2 font-medium border-r">{{ qualificador.dsc_qualificador }}</td>
                                <!-- Coluna Aplicar a Todos -->
                                <td class="p-2 border-r bg-gray-50">
                                    <div class="flex items-center gap-1">
                                        <select class="text-xs border rounded p-1 w-12"
                                            id="tipo_apply_desp_{{ qualificador.seq_qualificador }}">
                                            <option value="P">%</option>
                                            <option value="V">R$</option>
                                        </select>
                                        <input type="number" step="0.01" class="text-xs border rounded p-1 w-20"
                                            id="val_apply_desp_{{ qualificador.seq_qualificador }}" placeholder="Valor">
                                        <button type="button"
                                            onclick="aplicarTodos('desp', {{ qualificador.seq_qualificador }})"
                                            class="bg-blue-100 text-blue-600 p-1 rounded hover:bg-blue-200"
                                            title="Aplicar">
                                            <i data-lucide="arrow-right" class="h-4 w-4"></i>
                                        </button>
                                    </div>
                                </td>
                                {% for mes_num, mes_nome in meses_nomes.items() %}
                                <td class="p-1">
                                    <div class="flex flex-col gap-1">
                                        <select
                                            name="cod_tipo_ajuste_desp_{{ mes_num }}_{{ qualificador.seq_qualificador }}"
                                            class="text-[10px] border rounded p-0.5 w-full bg-gray-50">
                                            <option value="P">%</option>
                                            <option value="V">R$</option>
                                        </select>
                                        <input type="number" step="0.01"
                                            name="val_ajuste_desp_{{ mes_num }}_{{ qualificador.seq_qualificador }}"
                                            class="w-full text-xs p-1 border rounded text-right" placeholder="0.00">
                                    </div>
                                </td>
                                {% endfor %}
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="flex justify-end gap-4">
            <a href="{{ url_for('simulador_menu') }}"
                class="px-6 py-2 border rounded text-gray-600 hover:bg-gray-50">Cancelar</a>
            <button type="submit" class="px-6 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                Salvar Cenário
            </button>
        </div>
    </form>
</div>

<script>
(function () {
    const TOTAL_MESES = 12;
    let qualificadoresFilhos = [];  // Cache dos qualificadores filhos carregados

    function toggleReceitaFields() {
        const tipoSelect = document.getElementById('tipo_receita');
        const modelFields = document.getElementById('receita_model_fields');
        const hwParams = document.getElementById('hw_params');
        const arimaParams = document.getElementById('arima_params');
        const sarimaParams = document.getElementById('sarima_params');
        const regParams = document.getElementById('regressao_params');
        const commonParams = document.getElementById('common_model_params');
        const filhosContainer = document.getElementById('qualificador_filhos_container');

        if (!tipoSelect || !modelFields) {
            return;
        }

        // Esconder todos os parâmetros específicos
        [hwParams, arimaParams, sarimaParams, regParams].forEach(section => {
            if (section) {
                section.classList.add('hidden');
            }
        });
        if (commonParams) {
            commonParams.classList.remove('hidden');
        }
        if (filhosContainer) {
            filhosContainer.classList.add('hidden');
        }

        if (tipoSelect.value === 'MANUAL') {
            modelFields.classList.add('hidden');
            return;
        }

        modelFields.classList.remove('hidden');

        if (tipoSelect.value === 'HOLT_WINTERS' && hwParams) {
            hwParams.classList.remove('hidden');
            if (filhosContainer) filhosContainer.classList.remove('hidden');
        } else if (tipoSelect.value === 'ARIMA' && arimaParams) {
            arimaParams.classList.remove('hidden');
            if (filhosContainer) filhosContainer.classList.remove('hidden');
        } else if (tipoSelect.value === 'SARIMA' && sarimaParams) {
            sarimaParams.classList.remove('hidden');
            if (filhosContainer) filhosContainer.classList.remove('hidden');
        } else if (tipoSelect.value === 'REGRESSAO') {
            if (regParams) {
                regParams.classList.remove('hidden');
            }
            if (commonParams) {
                commonParams.classList.add('hidden');
            }
        }
        
        // Atualizar lista de filhos se necessário
        onQualificadorChange();
    }

    function toggleDespesaFields() {
        const tipoSelect = document.getElementById('tipo_despesa');
        const loaFields = document.getElementById('despesa_loa_fields');
        const mediaFields = document.getElementById('despesa_media_fields');

        if (!tipoSelect) {
            return;
        }

        if (loaFields) {
            loaFields.classList.add('hidden');
        }
        if (mediaFields) {
            mediaFields.classList.add('hidden');
        }

        if (tipoSelect.value === 'LOA' && loaFields) {
            loaFields.classList.remove('hidden');
        }
        if (tipoSelect.value === 'MEDIA_HISTORICA' && mediaFields) {
            mediaFields.classList.remove('hidden');
        }
    }

    async function onQualificadorChange() {
        const select = document.getElementById('receita_qualificador_select');
        const filhosContainer = document.getElementById('qualificador_filhos_container');
        const filhosList = document.getElementById('qualificador_filhos_list');
        const tipoReceita = document.getElementById('tipo_receita')?.value;
        
        if (!select || !filhosContainer || !filhosList) return;
        
        // Verificar se o modelo atual suporta qualificadores filhos
        const modelosComFilhos = ['HOLT_WINTERS', 'ARIMA', 'SARIMA', 'MEDIA_HISTORICA'];
        if (!modelosComFilhos.includes(tipoReceita)) {
            filhosContainer.classList.add('hidden');
            return;
        }
        
        const seqQualificador = select.value;
        const option = select.options[select.selectedIndex];
        const hasFilhos = option.dataset.hasFilhos === 'true';
        
        if (!hasFilhos) {
            filhosContainer.classList.add('hidden');
            return;
        }
        
        filhosContainer.classList.remove('hidden');
        
        try {
            const response = await fetch(`/simulador/qualificador/${seqQualificador}/filhos`);
            const data = await response.json();
            
            if (data.filhos && data.filhos.length > 0) {
                qualificadoresFilhos = data.filhos;
                renderFilhosList(data.filhos);
            } else {
                filhosContainer.classList.add('hidden');
            }
        } catch (error) {
            console.error('Erro ao carregar qualificadores filhos:', error);
            filhosContainer.classList.add('hidden');
        }
    }

    function renderFilhosList(filhos) {
        const filhosList = document.getElementById('qualificador_filhos_list');
        if (!filhosList) return;
        
        filhosList.innerHTML = `
            <p class="text-xs text-gray-500 mb-2">Selecione os qualificadores filhos para agregar:</p>
            <div class="space-y-1">
                <label class="flex items-center text-xs">
                    <input type="checkbox" id="selecionar_todos_filhos" onchange="toggleTodosFilhos(this.checked)" class="mr-2">
                    <strong>Selecionar todos</strong>
                </label>
                <hr class="my-1">
                ${filhos.map(f => `
                    <label class="flex items-center text-xs" style="padding-left: ${(f.nivel - 1) * 12}px">
                        <input type="checkbox" name="qualificador_filho[]" value="${f.seq_qualificador}" 
                            class="mr-2 filho-checkbox" ${f.is_folha ? 'checked' : ''}>
                        ${f.dsc_qualificador}
                    </label>
                `).join('')}
            </div>
        `;
    }

    function toggleFilhosSelection() {
        const checkbox = document.getElementById('usar_qualificadores_filhos');
        const filhosList = document.getElementById('qualificador_filhos_list');
        
        if (filhosList) {
            filhosList.classList.toggle('hidden', !checkbox.checked);
        }
    }

    function toggleTodosFilhos(checked) {
        document.querySelectorAll('.filho-checkbox').forEach(cb => {
            cb.checked = checked;
        });
    }

    function toggleTodosQualificadores(checked) {
        document.querySelectorAll('.qualificador-checkbox').forEach(cb => {
            cb.checked = checked;
        });
        atualizarContadorQualificadores();
    }
    
    function atualizarContadorQualificadores() {
        const count = document.querySelectorAll('.qualificador-checkbox:checked').length;
        const countEl = document.getElementById('qualificadores_count');
        if (countEl) {
            countEl.textContent = count;
        }
    }

    function getQualificadoresSelecionados() {
        return Array.from(document.querySelectorAll('.qualificador-checkbox:checked'))
            .map(cb => parseInt(cb.value));
    }
    
    function preencherLinhaQualificador(seqQualificador, projecao) {
        // Preenche APENAS a linha do qualificador especificado
        if (!projecao || !Array.isArray(projecao)) return;
        
        projecao.forEach((p, index) => {
            if (index < 12) {
                const mes = index + 1;
                const tipoField = document.querySelector(`select[name="cod_tipo_ajuste_${mes}_${seqQualificador}"]`);
                const valorField = document.querySelector(`input[name="val_ajuste_${mes}_${seqQualificador}"]`);

                if (tipoField) tipoField.value = 'V';
                if (valorField) valorField.value = p.valor_projetado.toFixed(2);
            }
        });
    }

    function aplicarTodos(type, seq) {
        const prefix = type === 'rec' ? '' : 'desp_';
        const tipoInput = document.getElementById(`tipo_apply_${type}_${seq}`);
        const valorInput = document.getElementById(`val_apply_${type}_${seq}`);

        if (!tipoInput || !valorInput || valorInput.value === '') {
            return;
        }

        for (let i = 1; i <= TOTAL_MESES; i++) {
            const tipoField = document.querySelector(`select[name="cod_tipo_ajuste_${prefix}${i}_${seq}"]`);
            const valorField = document.querySelector(`input[name="val_ajuste_${prefix}${i}_${seq}"]`);

            if (tipoField) {
                tipoField.value = tipoInput.value;
            }
            if (valorField) {
                valorField.value = valorInput.value;
            }
        }
    }

    function aplicarLOA() {
        document.querySelectorAll('.loa-input').forEach(input => {
            const seq = input.dataset.seq;
            const total = parseFloat(input.value);

            if (!seq || Number.isNaN(total)) {
                return;
            }

            const mensal = (total / TOTAL_MESES).toFixed(2);
            for (let i = 1; i <= TOTAL_MESES; i++) {
                const tipoField = document.querySelector(`select[name="cod_tipo_ajuste_desp_${i}_${seq}"]`);
                const valorField = document.querySelector(`input[name="val_ajuste_desp_${i}_${seq}"]`);

                if (tipoField) {
                    tipoField.value = 'V';
                }
                if (valorField) {
                    valorField.value = mensal;
                }
            }
        });

        alert('Valores LOA aplicados na tabela!');
    }

    async function aplicarModeloReceita() {
        const tipoSelect = document.getElementById('tipo_receita');
        if (!tipoSelect) return;

        const tipoModelo = tipoSelect.value;
        const statusEl = document.getElementById('projecao_status');

        if (tipoModelo === 'REGRESSAO') {
            const beta0 = parseFloat(document.getElementById('reg_beta0')?.value) || 0;
            const beta1 = parseFloat(document.getElementById('reg_beta1')?.value) || 0;
            const beta2 = parseFloat(document.getElementById('reg_beta2')?.value) || 0;
            const pib = parseFloat(document.getElementById('reg_val_pib')?.value) || 0;
            const inflacao = parseFloat(document.getElementById('reg_val_inflacao')?.value) || 0;

            const resultado = beta0 + (beta1 * pib) + (beta2 * inflacao);
            const resultadoFormatado = resultado.toFixed(2);

            preencherTabelaReceita(resultadoFormatado);
            alert('Valores da Regressão calculados e aplicados!');
            return;
        }

        if (['HOLT_WINTERS', 'ARIMA', 'SARIMA'].includes(tipoModelo)) {
            const btn = document.querySelector('button[onclick="aplicarModeloReceita()"]');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i data-lucide="loader" class="animate-spin"></i> Calculando...';
            btn.disabled = true;
            if (statusEl) statusEl.textContent = 'Processando modelo...';
            lucide.createIcons();

            try {
                const qualificadoresSelecionados = getQualificadoresSelecionados();
                
                if (qualificadoresSelecionados.length === 0) {
                    throw new Error('Selecione pelo menos um qualificador para projeção');
                }
                
                const mesesProjecao = document.querySelector('input[name="meses_projecao"]').value;
                const anoBase = document.querySelector('input[name="ano_base"]').value;
                
                let config = {};
                
                if (tipoModelo === 'HOLT_WINTERS') {
                    config = {
                        seasonal_periods: parseInt(document.querySelector('input[name="receita_config_seasonal_periods"]')?.value || 12),
                        trend: document.querySelector('select[name="receita_config_trend"]')?.value || 'add',
                        seasonal: document.querySelector('select[name="receita_config_seasonal"]')?.value || 'add',
                        damped_trend: document.querySelector('select[name="receita_config_damped_trend"]')?.value === 'true'
                    };
                } else if (tipoModelo === 'ARIMA') {
                    config = {
                        p: parseInt(document.querySelector('input[name="receita_config_p"]')?.value || 1),
                        d: parseInt(document.querySelector('input[name="receita_config_d"]')?.value || 1),
                        q: parseInt(document.querySelector('input[name="receita_config_q"]')?.value || 1),
                        auto_order: document.querySelector('select[name="receita_config_auto_order"]')?.value === 'true'
                    };
                } else if (tipoModelo === 'SARIMA') {
                    config = {
                        p: parseInt(document.querySelector('input[name="receita_config_p"]')?.value || 1),
                        d: parseInt(document.querySelector('input[name="receita_config_d"]')?.value || 1),
                        q: parseInt(document.querySelector('input[name="receita_config_q"]')?.value || 1),
                        P: parseInt(document.querySelector('input[name="receita_config_P"]')?.value || 1),
                        D: parseInt(document.querySelector('input[name="receita_config_D"]')?.value || 1),
                        Q: parseInt(document.querySelector('input[name="receita_config_Q"]')?.value || 1),
                        s: parseInt(document.querySelector('input[name="receita_config_s"]')?.value || 12)
                    };
                }

                // Processar cada qualificador individualmente
                let sucessos = 0;
                let erros = [];
                
                for (const seqQualificador of qualificadoresSelecionados) {
                    try {
                        if (statusEl) {
                            const nomeQual = document.querySelector(`.qualificador-checkbox[value="${seqQualificador}"]`)?.dataset.nome || seqQualificador;
                            statusEl.textContent = `Calculando ${tipoModelo} para ${nomeQual}...`;
                        }
                        
                        const response = await fetch('/simulador/calcular-projecao', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                tipo_modelo: tipoModelo,
                                seq_qualificador: seqQualificador,  // Um qualificador por vez
                                meses_projecao: mesesProjecao,
                                ano_base: anoBase,
                                config: config
                            })
                        });

                        const data = await response.json();

                        if (!response.ok) {
                            throw new Error(data.error || 'Erro ao calcular projeção');
                        }

                        // Preencher APENAS a linha do qualificador atual
                        preencherLinhaQualificador(seqQualificador, data.projecao);
                        sucessos++;
                        
                    } catch (error) {
                        const nomeQual = document.querySelector(`.qualificador-checkbox[value="${seqQualificador}"]`)?.dataset.nome || seqQualificador;
                        erros.push(`${nomeQual}: ${error.message}`);
                        console.error(`Erro no qualificador ${seqQualificador}:`, error);
                    }
                }

                // Mostrar resultado
                if (erros.length > 0) {
                    if (statusEl) statusEl.textContent = `✓ ${sucessos} calculado(s), ✗ ${erros.length} erro(s)`;
                    alert(`Projeção calculada!\n\nSucessos: ${sucessos}\nErros: ${erros.length}\n\nErros:\n${erros.join('\n')}`);
                } else {
                    if (statusEl) statusEl.textContent = `✓ ${tipoModelo} calculado com sucesso para ${sucessos} qualificador(es)`;
                    alert(`Projeção calculada com sucesso para ${sucessos} qualificador(es)!`);
                }

            } catch (error) {
                console.error(error);
                if (statusEl) statusEl.textContent = `✗ Erro: ${error.message}`;
                alert('Erro: ' + error.message);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
                lucide.createIcons();
            }
            return;
        }

        alert('Cálculo automático não disponível para este método.');
    }

    function preencherTabelaReceita(valorFixo) {
        const TOTAL_MESES = 12;
        document.querySelectorAll('tr[data-row-id^="rec-"]').forEach(row => {
            const [, seq] = row.dataset.rowId.split('-');
            for (let i = 1; i <= TOTAL_MESES; i++) {
                const tipoField = document.querySelector(`select[name="cod_tipo_ajuste_${i}_${seq}"]`);
                const valorField = document.querySelector(`input[name="val_ajuste_${i}_${seq}"]`);

                if (tipoField) tipoField.value = 'V';
                if (valorField) valorField.value = valorFixo;
            }
        });
    }

    function preencherTabelaReceitaComArray(projecao) {
        // projecao é array de {data: 'YYYY-MM-DD', valor_projetado: 123.45}
        // Assumindo que a projeção começa no mês 1 do ano base
        
        // Agrupar valores por mês (1 a 12)
        const valoresPorMes = {};
        projecao.forEach((p, index) => {
            if (index < 12) {
                valoresPorMes[index + 1] = p.valor_projetado.toFixed(2);
            }
        });

        document.querySelectorAll('tr[data-row-id^="rec-"]').forEach(row => {
            const [, seq] = row.dataset.rowId.split('-');
            for (let i = 1; i <= 12; i++) {
                const valor = valoresPorMes[i];
                if (valor !== undefined) {
                    const tipoField = document.querySelector(`select[name="cod_tipo_ajuste_${i}_${seq}"]`);
                    const valorField = document.querySelector(`input[name="val_ajuste_${i}_${seq}"]`);

                    if (tipoField) tipoField.value = 'V';
                    if (valorField) valorField.value = valor;
                }
            }
        });
    }

    async function aplicarMediaHistorica() {
        const periodoMeses = document.querySelector('input[name="despesa_config_periodo_meses"]')?.value || 12;
        const fatorAjuste = document.querySelector('input[name="despesa_config_fator_ajuste"]')?.value || 1.0;
        const anoBase = document.querySelector('input[name="ano_base"]')?.value;
        const mesesProjecao = document.querySelector('input[name="meses_projecao"]')?.value || 12;

        // Para cada qualificador de despesa, calcular a média histórica
        const qualificadores = document.querySelectorAll('tr[data-row-id^="desp-"]');
        
        for (const row of qualificadores) {
            const [, seq] = row.dataset.rowId.split('-');
            
            try {
                const response = await fetch('/simulador/calcular-projecao', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        tipo_modelo: 'MEDIA_HISTORICA',
                        seq_qualificador: seq,
                        meses_projecao: parseInt(mesesProjecao),
                        ano_base: parseInt(anoBase),
                        config: {
                            periodo_meses: parseInt(periodoMeses),
                            fator_ajuste: parseFloat(fatorAjuste),
                            considerar_sazonalidade: true
                        }
                    })
                });

                const data = await response.json();

                if (response.ok && data.projecao) {
                    data.projecao.forEach((p, index) => {
                        if (index < 12) {
                            const mes = index + 1;
                            const tipoField = document.querySelector(`select[name="cod_tipo_ajuste_desp_${mes}_${seq}"]`);
                            const valorField = document.querySelector(`input[name="val_ajuste_desp_${mes}_${seq}"]`);

                            if (tipoField) tipoField.value = 'V';
                            if (valorField) valorField.value = p.valor_projetado.toFixed(2);
                        }
                    });
                }
            } catch (error) {
                console.error(`Erro ao calcular média histórica para qualificador ${seq}:`, error);
            }
        }

        alert('Média histórica calculada e aplicada!');
    }

    function carregarDadosExistentes() {
        const form = document.getElementById('form-cenario');
        if (!form || !form.dataset.cenario) {
            console.log('carregarDadosExistentes: Sem dados de cenário');
            return;
        }

        let cenarioCompleto = null;
        try {
            cenarioCompleto = JSON.parse(form.dataset.cenario);
            console.log('carregarDadosExistentes: Dados carregados:', cenarioCompleto);
        } catch (error) {
            console.error('Erro ao interpretar dados do cenário:', error);
            return;
        }

        if (!cenarioCompleto) {
            return;
        }

        // Carregar configuração do modelo de receita
        if (cenarioCompleto.receita && cenarioCompleto.receita.config) {
            const tipoReceita = cenarioCompleto.receita.config.cod_tipo_cenario;
            const tipoSelect = document.getElementById('tipo_receita');
            if (tipoSelect) {
                tipoSelect.value = tipoReceita;
                console.log('Tipo receita definido:', tipoReceita);
            }

            // Carregar parâmetros do modelo se existirem
            const jsonConfig = cenarioCompleto.receita.config.json_configuracao;
            if (jsonConfig && typeof jsonConfig === 'object') {
                carregarParametrosModelo(jsonConfig, 'receita');
            }
        }

        // Carregar configuração do modelo de despesa
        if (cenarioCompleto.despesa && cenarioCompleto.despesa.config) {
            const tipoDespesa = cenarioCompleto.despesa.config.cod_tipo_cenario;
            const tipoSelect = document.getElementById('tipo_despesa');
            if (tipoSelect) {
                tipoSelect.value = tipoDespesa;
            }

            const jsonConfig = cenarioCompleto.despesa.config.json_configuracao;
            if (jsonConfig && typeof jsonConfig === 'object') {
                carregarParametrosModelo(jsonConfig, 'despesa');
            }
        }

        const preencher = (ajustes, prefixo) => {
            if (!Array.isArray(ajustes)) {
                console.log('preencher: ajustes não é array', ajustes);
                return;
            }
            
            console.log(`preencher: ${ajustes.length} ajustes para prefixo "${prefixo}"`);

            ajustes.forEach(ajuste => {
                const seqQual = ajuste.seq_qualificador;
                const mes = ajuste.mes;
                const tipoName = prefixo ?
                    `cod_tipo_ajuste_${prefixo}_${mes}_${seqQual}` :
                    `cod_tipo_ajuste_${mes}_${seqQual}`;
                const valorName = prefixo ?
                    `val_ajuste_${prefixo}_${mes}_${seqQual}` :
                    `val_ajuste_${mes}_${seqQual}`;

                const tipoField = document.querySelector(`select[name="${tipoName}"]`);
                const valorField = document.querySelector(`input[name="${valorName}"]`);

                if (tipoField) {
                    tipoField.value = ajuste.cod_tipo_ajuste || 'P';
                } else {
                    console.log(`Campo tipo não encontrado: ${tipoName}`);
                }
                if (valorField) {
                    valorField.value = ajuste.val_ajuste ?? '';
                } else {
                    console.log(`Campo valor não encontrado: ${valorName}`);
                }
            });
        };

        if (cenarioCompleto.receita && cenarioCompleto.receita.ajustes) {
            preencher(cenarioCompleto.receita.ajustes, '');
        }
        if (cenarioCompleto.despesa && cenarioCompleto.despesa.ajustes) {
            preencher(cenarioCompleto.despesa.ajustes, 'desp');
        }
    }

    function carregarParametrosModelo(config, tipo) {
        // Carregar parâmetros específicos do modelo
        for (const [key, value] of Object.entries(config)) {
            const input = document.querySelector(`[name="${tipo}_config_${key}"]`);
            if (input) {
                if (input.type === 'checkbox') {
                    input.checked = value === true || value === 'true';
                } else {
                    input.value = value;
                }
            }
        }

        // Carregar qualificadores selecionados se existirem
        if (config.seq_qualificadores && Array.isArray(config.seq_qualificadores)) {
            config.seq_qualificadores.forEach(seq => {
                const checkbox = document.querySelector(`.qualificador-checkbox[value="${seq}"]`);
                if (checkbox) {
                    checkbox.checked = true;
                }
            });
            atualizarContadorQualificadores();
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        toggleReceitaFields();
        toggleDespesaFields();
        carregarDadosExistentes();
        
        // Reativar os toggles após carregar dados
        setTimeout(() => {
            toggleReceitaFields();
            toggleDespesaFields();
        }, 100);
        
        // Adicionar listener para atualizar contador de qualificadores
        document.querySelectorAll('.qualificador-checkbox').forEach(cb => {
            cb.addEventListener('change', atualizarContadorQualificadores);
        });
        
        // Adicionar handler para o submit do formulário
        const form = document.getElementById('form-cenario');
        if (form) {
            form.addEventListener('submit', function(e) {
                // Atualizar o hidden input com os qualificadores selecionados
                const seqQualificadores = getQualificadoresSelecionados();
                const hiddenInput = document.getElementById('receita_seq_qualificadores_hidden');
                if (hiddenInput) {
                    hiddenInput.value = JSON.stringify(seqQualificadores);
                }
            });
        }
    });

    // Expor funções globalmente
    window.toggleReceitaFields = toggleReceitaFields;
    window.toggleDespesaFields = toggleDespesaFields;
    window.aplicarTodos = aplicarTodos;
    window.aplicarLOA = aplicarLOA;
    window.aplicarModeloReceita = aplicarModeloReceita;
    window.aplicarMediaHistorica = aplicarMediaHistorica;
    window.toggleTodosQualificadores = toggleTodosQualificadores;
    window.atualizarContadorQualificadores = atualizarContadorQualificadores;
})();
</script>
{% endblock %}